#-*-ruby-*-
#
# Copyright (c) 2004 SASADA Koichi <ko1 at atdot.net>
#
# This program is free software with ABSOLUTELY NO WARRANTY.
# You can re-distribute and/or modify this program under
# the same terms of the Ruby's lisence.
#
#
# Sixamo bot
#
# add config like this:
#
# BotConfig = {
#   :SixamoBot => {
#     :dir => 'dokoka',
#     :ch  => /nadoka/,
#     :tm  => 5
#     :id  => /(sixamo)|(ししゃも)/
#   }
# }
#
#
# $Id$
#

require 'sixamo'
require 'kconv'
class SixamoBot < Nadoka::NDK_Bot
  def bot_initialize
    @sixamo_dir = @bot_config[:dir] || '~/sixamo'
    @sixamo_ch  = @bot_config[:ch]  || '#nadoka'
    @sixamo_tm  = @bot_config[:tm]  || 10
    @sixamo_id  = @bot_config[:id]  || /(sixamo)|(ししゃも)/
    @sixamo_rt  = @bot_config[:rt]  || 5
    @prev = Time.now
    make_sixamo
  end

  def make_sixamo
    @sixamo = Sixamo.new(File.expand_path(@sixamo_dir))
  end
  
  def on_privmsg prefix, ch, msg
    return unless @sixamo_ch === ch
    
    begin
      msg = Kconv.toeuc(msg)
      @sixamo.memorize msg

      unless @sixamo_id === msg
        return if Kernel.rand(@sixamo_rt) != 1
        return if Time.now - @prev < @sixamo_tm
      end
      @prev = Time.now

      talk = @sixamo.talk(msg)
      @sixamo.memorize talk
      
      send_notice ch, 'sixamo: ' + talk.tojis
    rescue
      make_sixamo
    end

  end
end

